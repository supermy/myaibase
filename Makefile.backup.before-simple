# MyAIBase - Arch Linux AI Base ISO æ„å»ºç³»ç»Ÿ
# ä½¿ç”¨ç‹¬ç«‹çš„æ„å»ºè„šæœ¬æ¥æé«˜å¯ç»´æŠ¤æ€§

# é»˜è®¤ç›®æ ‡
default: build-ai

# é…ç½®å˜é‡
GGUF_FILE ?= ../myaibase/airootfs/opt/models/Qwen3-0.6B-Q8_0.gguf

# æ„å»ºè„šæœ¬ç›®å½•
SCRIPT_DIR = scripts

# æœ€å°åŒ–ISOæ„å»º
build-mini:
	@echo "ğŸ”¨ å¼€å§‹æ„å»ºæœ€å°åŒ–ISO..."
	@$(SCRIPT_DIR)/build-mini.sh

# åŸºç¡€ISOæ„å»º
build-base:
	@echo "ğŸ”¨ å¼€å§‹æ„å»ºåŸºç¡€ISO..."
	@$(SCRIPT_DIR)/build-base.sh

# AI ISOæ„å»ºï¼ˆé»˜è®¤ç›®æ ‡ï¼‰
build-ai:
	@echo "ğŸ”¨ å¼€å§‹æ„å»ºAI ISO..."
	@GGUF_FILE="$(GGUF_FILE)" $(SCRIPT_DIR)/build-ai.sh

# å¿«é€Ÿæ„å»º
quick-mini:
	@echo "âš¡ å¿«é€Ÿæ„å»ºæœ€å°åŒ–ISO..."
	@$(SCRIPT_DIR)/build-mini.sh -q

quick-base:
	@echo "âš¡ å¿«é€Ÿæ„å»ºåŸºç¡€ISO..."
	@$(SCRIPT_DIR)/build-base.sh -q

quick-ai:
	@echo "âš¡ å¿«é€Ÿæ„å»ºAI ISO..."
	@GGUF_FILE="$(GGUF_FILE)" $(SCRIPT_DIR)/build-ai.sh -q

# å‡†å¤‡å·¥ä½œç›®å½•
prepare:
	@echo "ğŸ“ å‡†å¤‡æ„å»ºå·¥ä½œç›®å½•..."
	@mkdir -p work out

# æ¸…ç†å·¥ä½œç›®å½•
clean:
	@echo "ğŸ§¹ æ¸…ç†å·¥ä½œç›®å½•..."
	@rm -rf work/*
	@rm -f airootfs/opt/models/*

# å®Œå…¨æ¸…ç†ï¼ˆåŒ…æ‹¬è¾“å‡ºç›®å½•ï¼‰
clean-all: clean
	@echo "ğŸ§¹ æ¸…ç†è¾“å‡ºç›®å½•..."
	@rm -rf out/*

# æµ‹è¯•æ„å»ºç¯å¢ƒ
test:
	@echo "ğŸ§ª æµ‹è¯•æ„å»ºç¯å¢ƒ..."
	@$(SCRIPT_DIR)/validate.sh deps

# éªŒè¯æ„å»ºç¯å¢ƒ
validate:
	@echo "ğŸ” éªŒè¯æ„å»ºç¯å¢ƒ..."
	@GGUF_FILE="$(GGUF_FILE)" $(SCRIPT_DIR)/validate.sh env

# è¿è¡Œå®Œæ•´æµ‹è¯•
test-all:
	@echo "ğŸ§ª è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶..."
	@GGUF_FILE="$(GGUF_FILE)" $(SCRIPT_DIR)/validate.sh all

# æ£€æŸ¥ç³»ç»Ÿä¾èµ–
check-deps:
	@echo "ğŸ” æ£€æŸ¥ç³»ç»Ÿä¾èµ–..."
	@$(SCRIPT_DIR)/validate.sh deps

# æ„å»ºæœ¬åœ°è½¯ä»¶ä»“åº“
local-repo:
	@echo "ğŸ“¦ æ„å»ºæœ¬åœ°è½¯ä»¶ä»“åº“..."
	@sudo $(SCRIPT_DIR)/local_repo.sh

# æ˜¾ç¤ºæ„å»ºä¿¡æ¯
info:
	@echo "ğŸ“Š MyAIBase æ„å»ºä¿¡æ¯:"
	@echo "   å·¥ä½œç›®å½•: work/"
	@echo "   è¾“å‡ºç›®å½•: out/"
	@echo "   é…ç½®æ–‡ä»¶: profiledef.sh"
	@echo "   è½¯ä»¶åŒ…åˆ—è¡¨: packages.x86_64"
	@echo "   è‡ªå®šä¹‰è„šæœ¬: airootfs/root/customize_airootfs.sh"
	@echo "   GGUFæ¨¡å‹æ–‡ä»¶: $(GGUF_FILE)"
	@echo "   æ„å»ºè„šæœ¬ç›®å½•: $(SCRIPT_DIR)/"
	@echo "   æœ¬åœ°ä»“åº“è„šæœ¬: local_repo.sh"

# æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
help:
	@echo "MyAIBase æ„å»ºç³»ç»Ÿ - ä½¿ç”¨ç‹¬ç«‹è„šæœ¬ç‰ˆæœ¬"
	@echo ""
	@echo "é…ç½®å˜é‡:"
	@echo "  GGUF_FILE     æŒ‡å®šGGUFæ¨¡å‹æ–‡ä»¶è·¯å¾„"
	@echo ""
	@echo "ä¸»è¦ç›®æ ‡:"
	@echo "  make build-mini   æ„å»ºæœ€å°åŒ–ISOé•œåƒï¼ˆæœ€å°ç³»ç»Ÿï¼‰"
	@echo "  make build-base   æ„å»ºåŸºç¡€ISOé•œåƒï¼ˆåŸºç¡€+ä¸­æ–‡æ”¯æŒï¼‰"
	@echo "  make build-ai     æ„å»ºAI ISOé•œåƒï¼ˆå®Œæ•´AIåŠŸèƒ½ï¼‰"
	@echo ""
	@echo "å¿«é€Ÿæ„å»ºï¼ˆé™é»˜æ¨¡å¼ï¼‰:"
	@echo "  make quick-mini   å¿«é€Ÿæ„å»ºæœ€å°åŒ–ISO"
	@echo "  make quick-base   å¿«é€Ÿæ„å»ºåŸºç¡€ISO"
	@echo "  make quick-ai     å¿«é€Ÿæ„å»ºAI ISO"
	@echo ""
	@echo "è¾…åŠ©ç›®æ ‡:"
	@echo "  make prepare      å‡†å¤‡æ„å»ºå·¥ä½œç›®å½•"
	@echo "  make clean        æ¸…ç†å·¥ä½œç›®å½•"
	@echo "  make clean-all    å®Œå…¨æ¸…ç†ï¼ˆåŒ…æ‹¬è¾“å‡ºç›®å½•ï¼‰"
	@echo "  make test         æµ‹è¯•æ„å»ºç¯å¢ƒ"
	@echo "  make validate     éªŒè¯æ„å»ºç¯å¢ƒ"
	@echo "  make test-all     è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶"
	@echo "  make check-deps   æ£€æŸ¥ç³»ç»Ÿä¾èµ–"
	@echo "  make local-repo   æ„å»ºæœ¬åœ°è½¯ä»¶ä»“åº“"
	@echo "  make info         æ˜¾ç¤ºæ„å»ºä¿¡æ¯"
	@echo "  make help         æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯"
	@echo ""
	@echo "ç¤ºä¾‹:"
	@echo "  make validate && make build-ai          # éªŒè¯åæ„å»ºAI ISO"
	@echo "  make build-ai GGUF_FILE=/path/to/model.gguf  # ä½¿ç”¨æŒ‡å®šæ¨¡å‹"
	@echo "  make quick-base                         # å¿«é€Ÿæ„å»ºåŸºç¡€ISO"
	@echo "  make clean-all build-mini               # æ¸…ç†åæ„å»ºæœ€å°åŒ–ISO"

# ä¼ ç»Ÿç›®æ ‡åˆ«åï¼ˆä¿æŒå…¼å®¹æ€§ï¼‰
mini: build-mini
base: build-base
ai: build-ai

# é»˜è®¤ç›®æ ‡åˆ«åï¼ˆä¿æŒå…¼å®¹æ€§ï¼‰
all: build-ai

.PHONY: default build-mini build-base build-ai quick-mini quick-base quick-ai prepare clean clean-all test validate test-all check-deps local-repo info help mini base ai all